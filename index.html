<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AUTOLINK | IoT Control Tower</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,300;0,900;1,900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --accent: #f472b6; --bg-dark: #0f172a; }
        body { background: #f8fafc; font-family: 'Kanit', sans-serif; }
        
        .iot-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .iot-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px -15px rgba(0,0,0,0.1); }
        
        .led-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .led-on { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .led-off { background: #cbd5e1; }

        .btn-toggle {
            transition: all 0.2s;
            border-radius: 1.25rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* สไตล์รักออมแบบซ่อนไว้ใน Logo */
        .logo-text {
            background: linear-gradient(to right, #6366f1, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
        <div>
            <h1 class="text-4xl font-[900] italic tracking-tighter logo-text">AUTOLINK <span class="text-slate-800 font-light">PRO</span></h1>
            <p class="text-[10px] font-bold text-slate-400 tracking-[0.3em] uppercase mt-1">Industrial IoT Ecosystem</p>
        </div>
        
        <div class="flex items-center gap-4 bg-white p-2 px-6 rounded-full shadow-sm border border-slate-100">
            <div id="status-dot" class="led-indicator led-off"></div>
            <span id="status-text" class="text-xs font-black text-slate-400 uppercase tracking-widest">Connecting...</span>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-12 gap-6">
        
        <div class="col-span-12 lg:col-span-4 iot-card p-8 relative overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Core Health</span>
                <i class="fas fa-thermometer-half text-pink-500"></i>
            </div>
            <div id="gauge-container"></div>
            <div class="text-center mt-[-40px]">
                <h2 id="live-value" class="text-6xl font-black text-slate-800 italic">00.0</h2>
                <p class="text-pink-500 font-bold tracking-widest">DEGREES CELSIUS</p>
            </div>
        </div>

        <div class="col-span-12 lg:col-span-8 iot-card p-8">
            <div class="flex justify-between items-center mb-6">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Data Streams</span>
                <div class="flex gap-2 text-[10px] font-bold">
                    <span class="text-blue-500">REAL-TIME</span>
                    <span class="text-slate-300">HISTORY</span>
                </div>
            </div>
            <div id="main-chart"></div>
        </div>

        <div class="col-span-12 lg:col-span-7 grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div class="iot-card p-6 border-l-4 border-l-slate-900">
                <h3 class="text-xs font-black text-slate-400 uppercase mb-4">Main Process</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="publishCmd('START')" class="btn-toggle p-4 bg-slate-900 text-white hover:bg-black active:scale-95">
                        <i class="fas fa-bolt"></i> START
                    </button>
                    <button onclick="publishCmd('STOP')" class="btn-toggle p-4 bg-white border-2 border-slate-100 text-slate-400 hover:border-red-200 hover:text-red-500 active:scale-95">
                        <i class="fas fa-power-off"></i> STOP
                    </button>
                </div>
            </div>

            <div class="iot-card p-6 border-l-4 border-l-pink-500">
                <h3 class="text-xs font-black text-slate-400 uppercase mb-4">Auxiliary Units</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="publishCmd('LIGHT_ON')" class="btn-toggle p-4 bg-pink-50 text-pink-600 border border-pink-100">
                        <i class="fas fa-lightbulb"></i> ON
                    </button>
                    <button onclick="publishCmd('LIGHT_OFF')" class="btn-toggle p-4 bg-white text-slate-300 border border-slate-100">
                        OFF
                    </button>
                </div>
            </div>
        </div>

        <div class="col-span-12 lg:col-span-5 iot-card p-8 flex flex-col justify-between">
            <div>
                <h3 class="text-xs font-black text-slate-400 uppercase mb-6 flex justify-between">
                    System Sensitivity <span id="thresh-val" class="text-pink-500 font-black text-lg">75%</span>
                </h3>
                <input type="range" id="threshold" min="0" max="100" value="75" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-900">
            </div>
            
            <div class="mt-8 pt-6 border-t border-slate-100 flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-[10px] font-black text-slate-300 uppercase">Operator</span>
                    <span class="text-sm font-black text-slate-700 italic">รักออม Edition</span>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-pink-500 to-rose-400 flex items-center justify-center text-white shadow-lg shadow-pink-200">
                    <i class="fas fa-user-gear"></i>
                </div>
            </div>
        </div>

    </main>

    <div id="love-popup" class="fixed inset-0 flex items-center justify-center z-[999] opacity-0 pointer-events-none transition-all duration-500">
        <div class="bg-white/90 backdrop-blur-2xl px-16 py-8 rounded-[3rem] border-4 border-pink-400 shadow-2xl text-center">
            <h1 class="text-8xl font-[900] italic tracking-tighter logo-text mb-2">รักออม</h1>
            <p class="text-xs font-black text-pink-400 uppercase tracking-[0.5em]">Command Executed</p>
        </div>
    </div>

    <script>
        const MY_IP = "172.20.10.3";
        const socket = io(window.location.hostname === "localhost" ? "http://localhost:3000" : `http://${MY_IP}:3000`);

        // Charts Setup
        const gauge = new ApexCharts(document.querySelector("#gauge-container"), {
            chart: { height: 280, type: 'radialBar' },
            series: [0],
            plotOptions: { radialBar: { startAngle: -90, endAngle: 90, track: { background: '#f1f5f9' }, dataLabels: { show: false } } },
            colors: ['#f472b6'],
            stroke: { lineCap: 'round' }
        });
        gauge.render();

        const chart = new ApexCharts(document.querySelector("#main-chart"), {
            chart: { height: 250, type: 'area', toolbar: false, sparkline: { enabled: false } },
            series: [{ name: 'Sensor', data: [] }],
            xaxis: { type: 'datetime', range: 60000, labels: { style: { colors: '#cbd5e1', fontSize: '10px' } } },
            yaxis: { labels: { style: { colors: '#cbd5e1', fontSize: '10px' } } },
            colors: ['#6366f1'],
            stroke: { curve: 'smooth', width: 3 },
            fill: { type: 'gradient', gradient: { opacityFrom: 0.2, opacityTo: 0 } },
            grid: { borderColor: '#f1f5f9' }
        });
        chart.render();

        // Socket Logic
        socket.on('telemetry_stream', (data) => {
            const val = parseFloat(data.value).toFixed(1);
            document.getElementById('live-value').innerText = val;
            gauge.updateSeries([val]);
            chart.appendData([{ data: [{ x: new Date().getTime(), y: val }] }]);
        });

        const publishCmd = (cmd) => {
            socket.emit('control_device', { deviceId: 'ESP32_01', command: cmd });
            
            // ถ้ากดปุ่ม START ให้แสดงเอฟเฟกต์รักออม
            if(cmd === 'START') {
                const popup = document.getElementById('love-popup');
                popup.classList.replace('opacity-0', 'opacity-100');
                popup.classList.remove('scale-90');
                setTimeout(() => {
                    popup.classList.replace('opacity-100', 'opacity-0');
                }, 1200);
            }
            
            if (navigator.vibrate) navigator.vibrate(50);
        };

        document.getElementById('threshold').oninput = function() {
            document.getElementById('thresh-val').innerText = this.value + "%";
            socket.emit('set_threshold', { value: this.value });
        };

        socket.on('connect', () => {
            document.getElementById('status-dot').className = "led-indicator led-on";
            document.getElementById('status-text').innerText = "System Online";
            document.getElementById('status-text').className = "text-xs font-black text-green-600 uppercase tracking-widest";
        });

        socket.on('disconnect', () => {
            document.getElementById('status-dot').className = "led-indicator led-off";
            document.getElementById('status-text').innerText = "System Offline";
            document.getElementById('status-text').className = "text-xs font-black text-red-400 uppercase tracking-widest";
        });
    </script>
</body>
</html>